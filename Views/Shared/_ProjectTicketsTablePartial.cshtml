@using Microsoft.AspNetCore.Identity;
@model IEnumerable<Ticket>
@inject UserManager<BTUser> _UserManager
@inject IRoleService _RoleService
@{
    BTUser? currentUser = await _UserManager.GetUserAsync(User);
    bool userIsAdmin = await _RoleService.IsUserInRoleAsync(currentUser, nameof(BTRoles.Admin));
}

<div class="card custom-card overflow-hidden">
    <div class="card-body ps-3">
        <div class="table-responsive">
            <table class="table text-nowrap table-hover">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Developer</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (Ticket? ticket in Model)
                    {
                        <tr>
                            <td>@ticket.Title</td>
                            <td>
                                @if (ticket.DeveloperUser == null)
                                {
                                    <a class="badge bg-secondary" asp-action="AssignDeveloper"
                                       asp-controller="Tickets" asp-route-ticketId="@ticket.Id">
                                        Assign Developer
                                    </a>
                                }
                                else
                                {
                                    @ticket.DeveloperUser.FullName
                                }
                            </td>
                            <td>
                                <span class="badge bg-success">@ticket.TicketStatus?.Name</span>
                            </td>
                            <td>
                                <span class="badge bg-warning">@ticket.TicketPriority?.Name</span>
                            </td>
                            <td>
                                @ticket.Created.ToString("MM.dd.yyyy")
                            </td>
                            <td class="d-flex">
                                <a asp-action="Details" asp-controller="Ticket"
                                   asp-route-id="ticket.Id" class="badge bg-info">
                                    <i class="bi bi-eye-fill"></i>
                                </a>
                                @if (userIsAdmin)
                                {
                                    <a asp-action="Edit" asp-controller="Ticket"
                                       asp-route-id="ticket.Id" class="badge bg-secondary ms-1">
                                        <i class="bi bi-pencil-fill"></i>
                                    </a>
                                    @if (!ticket.Archived || !ticket.ArchivedByProject)
                                    {
                                        <a asp-action="ConfirmArchive" asp-controller="Ticket"
                                           asp-route-ticketId="ticket.Id" class="badge bg-danger ms-1">
                                            <i class="bi bi-archive-fill"></i>
                                        </a>
                                    }
                                    else
                                    {
                                        <a asp-action="ConfirmUnarchive" asp-controller="Ticket"
                                           asp-route-ticketId="ticket.Id" class="badge bg-danger ms-1">
                                            <i class="bi bi-archive-fill"></i>
                                        </a>
                                    }
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>